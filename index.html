<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Gummy Beerz — 96.6% RTP — 3x3 — 5 Lines</title>
  <style>
    :root{ --bg:#0b0f14; --panel:#410064; --panelBorder:#5a098c; --ink:#eaf2ff; --muted:#e2cfff; --accent:#7aa6ff; --accent2:#3fd0b5; --radius:18px; --shadow:0 8px 20px rgba(0,0,0,.35); --brand:#1e2a44; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0a0e13,#0b1220 40%,#0a0e13);color:var(--ink);font:500 16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Helvetica,Arial,sans-serif;overflow:hidden}
    .app{min-height:100vh;height:100vh;height:100dvh;display:grid;grid-template-rows:auto 1fr auto;gap:10px;padding:10px}
    header{display:flex;align-items:center;gap:14px;position:relative;justify-content:center}
    .brand{display:flex;align-items:center;gap:14px;flex:1;justify-content:center}
    .brand .logo{height:clamp(56px,8vmin,96px);width:auto;display:block;max-width:min(60vw,620px)}
    .badge{padding:4px 10px;border-radius:999px;background:#0e1826;color:var(--muted);font-size:12px;border:1px solid #1c2a40;position:absolute;right:10px;top:50%;transform:translateY(-50%)}
    .card{background:var(--panel);border:1px solid var(--panelBorder);border-radius:var(--radius);box-shadow:var(--shadow)}

    .stage{display:grid;grid-template-rows:1fr auto;gap:10px;min-height:0}
    .board{display:grid;place-items:center;padding:10px;min-height:0;overflow:hidden;position:relative}
    .beer-bg{position:absolute;inset:0;width:100%;height:100%;z-index:0;pointer-events:none;border-radius:inherit}
    .board-inner{position:relative;z-index:1}
    .board-inner{width:min(560px,90vmin,100%);height:min(560px,90vmin,100%);display:grid;grid-template-rows:repeat(3,1fr);grid-template-columns:repeat(3,1fr);gap:10px;max-width:100%;max-height:100%}
    .rowWrap{grid-column:1/-1;display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    .cell{display:grid;place-items:center;border-radius:16px;background:transparent;border:2px solid #6ad3ff;box-shadow:0 0 10px rgba(255,90,223,.6);transition:filter .2s ease, transform .2s ease;will-change:transform;overflow:hidden}
    .cell.win{box-shadow:0 0 26px rgba(255,20,147,.95),0 0 60px rgba(122,166,255,.55),0 0 90px rgba(255,20,147,.35)}
    .cell.win img.symbol-img{filter:drop-shadow(0 0 14px rgba(255,20,147,.9)) drop-shadow(0 0 26px rgba(122,166,255,.55));}
    .cell img.symbol-img{width:72%;height:auto;display:block;pointer-events:none;user-select:none}
    .cell.spinRow{filter:blur(0.45px) brightness(1.03)}

    .meters{display:flex;gap:12px;justify-content:space-between;align-items:center;padding:10px 12px;background:var(--panel);border:1px solid var(--panelBorder);border-radius:14px}
    .muted{color:var(--muted)}

    .controls{display:grid;grid-template-columns:repeat(12,1fr);gap:10px;padding:10px}
    .controls .box{grid-column:span 12;background:var(--panel);border:1px solid var(--panelBorder);border-radius:14px;padding:10px}
    @media(min-width:1100px){ .controls .box.balance{grid-column:span 3} .controls .box.stake{grid-column:span 9} }
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .grow{flex:1}

    button{appearance:none;background:#13263f;color:var(--ink);border:1px solid #1f3556;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer}
    button.primary{background:linear-gradient(180deg,#16a10a,#119d00);border-color:#0d7a00;color:#fff}
    button.ghost{background:#101a29;border:1px solid #1e2d45}
    button.on{outline:2px solid var(--accent)}
    button.circle{width:48px;height:48px;border-radius:999px;padding:0;display:grid;place-items:center;font-size:20px}
    button:disabled{opacity:.6;cursor:not-allowed}

    /* Icon buttons */
    button.circle{position:relative}
    button.circle img.icon-img{width:44px;height:44px;display:block;pointer-events:none;filter:drop-shadow(0 0 3px rgba(255,255,255,.15))}
    /* Muted slash overlay for audio button */
    button.circle.icon-sound.is-muted::after{content:"";position:absolute;left:50%;top:50%;width:44px;height:5px;background:#ff3366;border-radius:3px;transform:translate(-50%,-50%) rotate(-35deg);box-shadow:0 0 10px rgba(255,51,102,.8)}

    dialog{border:none;border-radius:16px;background:#0e1826;color:var(--ink);max-width:720px;width:calc(100% - 24px)}
    dialog::backdrop{background:rgba(0,0,0,.55)}
    .hide{display:none}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #1a2a44;font-size:13px}
    th{color:var(--muted);text-align:left}

    .stepper{display:flex;align-items:center;gap:10px}
    .stepper .val{min-width:100px;text-align:center;padding:10px 14px;border-radius:10px;background:#121b2a;border:1px solid #1d2e47;font-weight:800}

    @keyframes winPulse{0%{box-shadow:0 0 0 rgba(0,0,0,0);transform:scale(1)}35%{box-shadow:0 0 34px rgba(255,20,147,.95),0 0 70px rgba(122,166,255,.55);transform:scale(1.05)}55%{box-shadow:0 0 46px rgba(255,20,147,1),0 0 90px rgba(122,166,255,.65);transform:scale(1.06)}100%{box-shadow:0 0 0 rgba(0,0,0,0);transform:scale(1)}}
    .cell.win{animation:winPulse 1.3s ease-in-out 3}
    @keyframes settleX{0%{transform:translateX(-6px)}60%{transform:translateX(0)}100%{transform:translateX(0)}}
    .cell.settle{animation:settleX .28s ease-out 1}
    @keyframes winPulseStrong{0%{box-shadow:0 0 0 rgba(0,0,0,0);transform:scale(1)}30%{box-shadow:0 0 40px rgba(255,20,147,.98),0 0 90px rgba(122,166,255,.7);transform:scale(1.06)}55%{box-shadow:0 0 70px rgba(255,20,147,1),0 0 120px rgba(122,166,255,.75);transform:scale(1.08)}100%{box-shadow:0 0 0 rgba(0,0,0,0);transform:scale(1)}}
    .cell.win{animation:winPulseStrong 1.6s ease-in-out 3}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="brand">
        <img src="https://ik.imagekit.io/wholesomety/Gummy%20%20Beerz/Untitled%20design.svg" alt="Gummy Beerz" class="logo"/>
      </div>
      <div class="badge">Min R0.50 - Max R50</div>
    </header>

    <section class="card stage">
      <div class="board">
        <canvas id="beerBg" class="beer-bg"></canvas>
        <div class="board-inner" id="board"></div>
      </div>
      <div class="meters muted">
        <div id="autoHUD" class="muted hide">Auto: 0</div>
        <div class="grow"></div>
        <div>Last Win: <strong id="lastWin">0.00</strong></div>
      </div>
    </section>

    <section class="card controls">
      <div class="box balance">
        <label>Balance</label>
        <div class="row"><div style="font-size:20px;font-weight:800" id="balance">500.00</div><div class="muted">ZAR</div></div>
      </div>
      <div class="box stake">
        <label>Controls</label>
        <div class="row" style="gap:14px;align-items:center">
          <div class="row" style="gap:10px;align-items:center">
            <button id="minus" class="circle">−</button>
            <button id="spin" class="primary">SPIN</button>
            <button id="plus" class="circle">＋</button>
          </div>
          <button id="autoOpen" class="ghost">Autoplay</button>
          <button id="info" class="circle ghost" title="Info" aria-label="Info"><img class="icon-img" src="https://ik.imagekit.io/wholesomety/Gummy%20%20Beerz/info%20icon.png" alt=""></button>
          <button id="audioBtn" class="circle ghost icon-sound" title="Audio" aria-label="Audio"><img class="icon-img" src="https://ik.imagekit.io/wholesomety/Gummy%20%20Beerz/sound%20icon.png" alt=""></button>
          <div class="grow"></div>
          <div class="muted">Total Bet: <strong id="totalBet">0.50</strong> (5 lines)</div>
        </div>
      </div>
    </section>
  </div>

  <!-- Info / Paytable Modal -->
  <dialog id="modalPay">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;padding:8px 0">
      <strong>Game Info</strong>
      <div id="ptMeta" class="muted" style="font-size:12px"></div>
      <button id="closePay">Close</button>
    </div>
    <div class="muted" style="margin-bottom:8px">RTP: <strong>96.6%</strong>. Grid <strong>3×3</strong>. Lines: <strong>5 fixed</strong>. Wins pay <strong>left→right</strong> on adjacent reels. <strong>3-of-a-kind</strong> only. Pays are per line bet; Total bet = 5 × line bet. Highest win per line only.</div>
    <table>
      <thead><tr><th>Symbol</th><th>3 of a kind (R)</th></tr></thead>
      <tbody id="ptBody"></tbody>
    </table>
  </dialog>

  <!-- Bet Modal -->
  <dialog id="modalBet">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;padding:8px 0">
      <strong>Bet Settings</strong>
      <button id="betClose">Close</button>
    </div>
    <div class="row" style="margin:6px 0">
      <div class="grow">
        <div class="muted">BET LEVEL</div>
        <div class="stepper"><button id="levelMinus" class="circle">−</button><div class="val" id="levelVal">1</div><button id="levelPlus" class="circle">＋</button></div>
      </div>
      <div class="grow">
        <div class="muted">COIN VALUE</div>
        <div class="stepper"><button id="coinMinus" class="circle">−</button><div class="val" id="coinVal">0.10</div><button id="coinPlus" class="circle">＋</button></div>
      </div>
    </div>
    <div class="row" style="margin:10px 0">
      <div class="muted">Total Bet:</div><div><strong id="betPreview">R0.50</strong></div>
      <div class="grow"></div>
      <button id="betMax" class="ghost">Bet Max</button>
      <button id="betApply" class="primary">Apply</button>
    </div>
  </dialog>

  <!-- Audio / Sound Modal -->
  <dialog id="modalAudio">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;padding:8px 0">
      <strong>Audio</strong>
      <button id="audioClose">Close</button>
    </div>
    <div class="row" style="margin:8px 0">
      <label class="row" style="gap:10px;align-items:center">
        <input type="checkbox" id="audioMute" />
        <span class="muted">Mute all sound</span>
      </label>
    </div>
    <div style="margin:10px 0">
      <label for="audioVol" class="muted">Master volume</label>
      <input id="audioVol" type="range" min="0" max="1" step="0.01" style="width:100%" />
    </div>
  </dialog>

  <!-- Autoplay Modal -->
  <dialog id="modalAuto">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;padding:8px 0">
      <strong>Autoplay Settings</strong>
      <button id="autoClose">Close</button>
    </div>
    <div class="row" style="gap:20px">
      <label class="row"><input type="checkbox" id="autoTurbo"> <span class="muted">Turbo spin</span></label>
      <label class="row"><input type="checkbox" id="autoQuick"> <span class="muted">Quick spin</span></label>
      <label class="row"><input type="checkbox" id="autoSkip" checked> <span class="muted">Skip screens</span></label>
    </div>
    <div style="margin:12px 0" class="muted">NUMBER OF AUTOSPINS</div>
    <input type="range" id="autoRange" min="0" max="5" value="2" style="width:100%">
    <div class="row" style="margin:8px 0">
      <div class="muted">Selected:</div>
      <strong id="autoLabel">50</strong>
      <div class="grow"></div>
      <button id="autoStart" class="primary">Start Autoplay (50)</button>
    </div>
  </dialog>

<script>
(() => {
  const W = typeof window !== 'undefined' ? window : (typeof globalThis !== 'undefined' ? globalThis : {});
  const D = typeof document !== 'undefined' ? document : null;

  if (W && W.addEventListener) {
    W.addEventListener('error', (e) => { const el=D && D.querySelector('#status'); if(el) el.textContent='Error: '+e.message; });
  }

  const TARGET_RTP = 0.966; const DURATION_NORMAL=1250, DURATION_QUICK=800, DURATION_TURBO=550;
  const LINES=[[1,1,1],[0,0,0],[2,2,2],[0,1,2],[2,1,0]];
  const SYMBOLS=[
    {id:0,name:'Strawberry Radler',img:'https://ik.imagekit.io/wholesomety/Gummy%20%20Beerz/sym0.png'},
    {id:1,name:'Blueberry Wheat',img:'https://ik.imagekit.io/wholesomety/Gummy%20%20Beerz/sym1.png'},
    {id:2,name:'Lemon Lager',img:'https://ik.imagekit.io/wholesomety/Gummy%20%20Beerz/sym2.png'},
    {id:3,name:'Grape Stout',img:'https://ik.imagekit.io/wholesomety/Gummy%20%20Beerz/sym3.png'},
    {id:4,name:'Tropical Ale',img:'https://ik.imagekit.io/wholesomety/Gummy%20%20Beerz/sym4.png'},
    {id:5,name:'Citrus IPA',img:'https://ik.imagekit.io/wholesomety/Gummy%20%20Beerz/sym5.png'},
    {id:6,name:'Lime Cider',img:'https://ik.imagekit.io/wholesomety/Gummy%20%20Beerz/sym6.png'},
    {id:7,name:'Classic Amber Beer',img:'https://ik.imagekit.io/wholesomety/Gummy%20%20Beerz/sym7.png'},
    {id:8,name:'Cherry Ale',img:'https://ik.imagekit.io/wholesomety/Gummy%20%20Beerz/sym8.png'}
  ];
  const PAY3={0:400,1:300,2:200,3:100,4:70,5:20,6:20,7:20,8:20};
  const ROWS=[
    [5,6,7,8,6,7,8,5,6,7,8,5,6,7,8,5,6,7,8,5,6,7,8,5,6,7,8,5,6,7,8,6,7,5,6,7,8,5,6,7,8,4,4,3,4,3,4,5,6,7,8,6,7,8],
    [3,4,3,5,6,3,4,7,3,4,8,3,4,5,3,4,6,3,4,7,3,4,8,3,4,5,6,7,8,3,4,5,6,7,8,3,4,5,6,7,8,3,4,5,6,7,8,3,4,2,3,4,5,6],
    [6,5,6,4,6,5,6,4,6,5,6,4,6,5,6,4,6,5,6,4,6,5,6,4,6,5,6,4,6,5,3,3,3,4,4,4,2,6,5,6,0,6,5,6,4,6,5,6,4,6,5,6,4,6]
  ];

  // ===== AUDIO MANAGER =====
  const AM = (() => {
    let started=false; const els={};
    const conf=Object.assign({
      music:{ src:[
        'https://ik.imagekit.io/wholesomety/Gummy%20%20Beerz/gummy_menu_loop.ogg',
        'https://ik.imagekit.io/wholesomety/Gummy%20%20Beerz/gummy_menu_loop.wav'
      ], loop:true, vol:0.50 },
      fizz:{ src:[
        'https://ik.imagekit.io/wholesomety/Gummy%20%20Beerz/amb_fizz_loop_01.ogg',
        'https://ik.imagekit.io/wholesomety/Gummy%20%20Beerz/amb_fizz_loop_01.mp3',
        'https://ik.imagekit.io/wholesomety/Gummy%20%20Beerz/amb_fizz_loop_01.wav'
      ], loop:true, vol:0.12 },
      tap:{ src:[
        'https://ik.imagekit.io/wholesomety/Gummy%20%20Beerz/btn_tap_1.ogg',
        'https://ik.imagekit.io/wholesomety/Gummy%20%20Beerz/btn_tap_1.wav'
      ], loop:false, vol:0.6 },
      pour:{ src:[
        'https://impressive-magenta-hcutitjuo9.edgeone.app/pour_short_01.mp3',
        'https://ik.imagekit.io/wholesomety/Gummy%20%20Beerz/pour_short_01.ogg',
        'https://ik.imagekit.io/wholesomety/Gummy%20%20Beerz/pour_short_01.mp3',
        'https://ik.imagekit.io/wholesomety/Gummy%20%20Beerz/pour_short_01.wav'
      ], loop:false, vol:0.7 },
      spinStart:{ src:[
        'https://ik.imagekit.io/wholesomety/Gummy%20%20Beerz/spin_start_01.ogg',
        'https://ik.imagekit.io/wholesomety/Gummy%20%20Beerz/spin_start_01.wav'
      ], loop:false, vol:0.75 },
      spinLoop:{ src:[
        'https://ik.imagekit.io/wholesomety/Gummy%20%20Beerz/spin_loop_01.wav'
      ], loop:true, vol:0.25 },
      reel1:{ src:[
        'https://ik.imagekit.io/wholesomety/Gummy%20%20Beerz/reel_stop_01.ogg',
        'https://ik.imagekit.io/wholesomety/Gummy%20%20Beerz/reel_stop_01.wav'
      ], loop:false, vol:0.55 },
      reel2:{ src:[
        'https://ik.imagekit.io/wholesomety/Gummy%20%20Beerz/reel_stop_02.ogg',
        'https://ik.imagekit.io/wholesomety/Gummy%20%20Beerz/reel_stop_02.wav'
      ], loop:false, vol:0.55 },
      reel3:{ src:[
        'https://ik.imagekit.io/wholesomety/Gummy%20%20Beerz/reel_stop_03.wav'
      ], loop:false, vol:0.55 },
      winTotal:{ src:[
        'https://ik.imagekit.io/wholesomety/Gummy%20%20Beerz/win_total_01.ogg',
        'https://ik.imagekit.io/wholesomety/Gummy%20%20Beerz/win_total_01.wav'
      ], loop:false, vol:0.9 },
      bigWin:{ src:[
        'https://ik.imagekit.io/wholesomety/Gummy%20%20Beerz/big_win_01.ogg',
        'https://ik.imagekit.io/wholesomety/Gummy%20%20Beerz/big_win_01.wav'
      ], loop:false, vol:0.95 },
      winLine:{ src:[
        'https://ik.imagekit.io/wholesomety/Gummy%20%20Beerz/win_line_01.ogg',
        'https://ik.imagekit.io/wholesomety/Gummy%20%20Beerz/win_line_01.wav'
      ], loop:false, vol:0.8 },
      spinStop:{ src:[
        'https://ik.imagekit.io/wholesomety/Gummy%20%20Beerz/spin_stop_01.ogg',
        'https://ik.imagekit.io/wholesomety/Gummy%20%20Beerz/spin_stop_01.wav'
      ], loop:false, vol:0.55 }
    }, (W && W.GB_AUDIO)||{});

    let master = parseFloat((W.localStorage && W.localStorage.getItem('GB_MASTER'))||'0.80');
    let muted  = ((W.localStorage && W.localStorage.getItem('GB_MUTED'))||'0')==='1';

    const pickSrc = (list) => {
      if(!list) return '';
      if(typeof list==='string') list=[list];
      const a=new Audio();
      const order=['ogg','mp3','wav'];
      for(let oi=0; oi<order.length; oi++){
        const ext=order[oi];
        for(let i=0;i<list.length;i++){
          const s=list[i]; const sl=s.toLowerCase();
          const path = sl.split('?')[0]; // ignore query strings
          if(path.endsWith('.'+ext)){
            if(ext==='ogg'  && a.canPlayType('audio/ogg'))   return s;
            if(ext==='mp3'  && a.canPlayType('audio/mpeg'))  return s;
            if(ext==='wav'  && (a.canPlayType('audio/wav')||a.canPlayType('audio/x-wav'))) return s;
          }
        }
      }
      return Array.isArray(list) && list.length ? list[0] : '';
    };
    const applyVol = (name, el) => { const a = el || els[name]; if(!a) return; const bv = parseFloat(a.dataset.baseVol||'0.5'); a.volume = muted?0:Math.max(0, Math.min(1, bv*master)); };
    const applyAll = () => { Object.keys(els).forEach((k)=>applyVol(k)); };
    const ensure = (name) => { if(els[name]) return els[name]; const cfg=conf[name]; if(!cfg) return null; const a=new Audio(); a.preload='auto'; const list = Array.isArray(cfg.src)? cfg.src.slice() : [cfg.src]; const tried = new Set(); const best = pickSrc(list); tried.add(best); a.src = best || (list[0]||''); a.loop=!!cfg.loop; a.dataset.baseVol = (cfg.vol==null?0.5:cfg.vol); a.addEventListener('error', ()=>{ const alt = list.find(u=>!tried.has(u)); if(alt){ tried.add(alt); a.src = alt; try{ a.load(); }catch(_){} } }); applyVol(name,a); els[name]=a; return a };

    const unlock = () => { if(started) return; started=true; Object.keys(conf).forEach((k)=>{ ensure(k); try{ els[k].muted=true; const p=els[k].play(); if(p&&p.then) p.then(()=>{ els[k].pause(); els[k].currentTime=0; els[k].muted=false; }); }catch(_){} }); if(isMuted() || getMaster()<=0.001){ setMuted(false); setMaster(0.5); } play('music'); play('fizz'); };
    const play = (name,opts) => { const a=ensure(name); if(!a) return; if(opts&&opts.loop!=null) a.loop=!!opts.loop; if(opts&&opts.volume!=null){ a.dataset.baseVol = String(opts.volume); } applyVol(name,a); try{ a.currentTime=0; const p=a.play(); if(p&&p.catch) p.catch(()=>{}); }catch(_){} };
    const stop = (name) => { const a=els[name]; if(!a) return; try{ a.pause(); }catch(_){} };
    const fadeOut = (name,ms) => { const a=els[name]; if(!a) return; const start=a.volume, t0=performance.now(); const step=(t)=>{ const k=Math.min(1,(t-t0)/ms); a.volume=start*(1-k); if(k<1) requestAnimationFrame(step); else stop(name); }; requestAnimationFrame(step); };

    const setMaster = (v)=>{ master=Math.max(0,Math.min(1,Number(v)||0)); if(W.localStorage) W.localStorage.setItem('GB_MASTER', String(master)); applyAll(); };
    const getMaster = ()=> master;
    const setMuted  = (m)=>{ muted=!!m; if(W.localStorage) W.localStorage.setItem('GB_MUTED', muted?'1':'0'); applyAll(); };
    const isMuted   = ()=> !!muted;
    const toggleMuted = ()=> setMuted(!muted);

    return {ensure, play, stop, fadeOut, unlock, setMaster, getMaster, setMuted, isMuted, toggleMuted, getEl:(n)=>els[n]};
  })();

  let balance=500.00; let spinning=false; let autoRunning=false, autoLeft=0; let turbo=false, quick=false;
  const coinValues=[0.10,0.20,0.30,0.40,0.50,0.60,0.70,0.80,0.90,1.00];
  const betLevels=[1,2,3,4,5,6,7,8,9,10];
  let coinIdx=0, levelIdx=0; const autoSteps=[10,20,50,100,500,1000];

  const $ = (s)=> D.querySelector(s);
  const board=$('#board'), balEl=$('#balance'), totalBetEl=$('#totalBet'), lastWinEl=$('#lastWin'), statusEl=$('#status'), autoHUD=$('#autoHUD');
  const beerCanvas=$('#beerBg');
  const spinBtn=$('#spin'), minusBtn=$('#minus'), plusBtn=$('#plus');
  const infoBtn=$('#info'), autoOpen=$('#autoOpen');
  const audioBtn=$('#audioBtn'); const modalAudio=$('#modalAudio'), audioVol=$('#audioVol'), audioMute=$('#audioMute'), audioClose=$('#audioClose');
  const modalPay=$('#modalPay'), closePay=$('#closePay'), ptBody=$('#ptBody');
  const modalBet=$('#modalBet'), betClose=$('#betClose'), levelMinus=$('#levelMinus'), levelPlus=$('#levelPlus'), coinMinus=$('#coinMinus'), coinPlus=$('#coinPlus'), levelVal=$('#levelVal'), coinVal=$('#coinVal'), betPreview=$('#betPreview'), betApply=$('#betApply'), betMax=$('#betMax');
  const modalAuto=$('#modalAuto'), autoClose=$('#autoClose'), autoTurbo=$('#autoTurbo'), autoQuick=$('#autoQuick'), autoSkip=$('#autoSkip'), autoRange=$('#autoRange'), autoLabel=$('#autoLabel'), autoStart=$('#autoStart');

  const fmt=(n)=> Number(n).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
  const perLine=()=> betLevels[levelIdx]*coinValues[coinIdx];
  const totalBet=()=> perLine()*5;
  const setBalance=(v)=>{ balance=Math.max(0,Number(v)||0); balEl.textContent=fmt(balance); updateBet(); };
  const updateBet=()=>{ totalBetEl.textContent=fmt(totalBet()); if(spinBtn) spinBtn.disabled = totalBet()>balance };
  const setStatus=(m)=>{ if(statusEl) statusEl.textContent=m };

  const buildBoard=()=>{ if(!board) return; board.innerHTML=''; for(let r=0;r<3;r++){ const row=D.createElement('div'); row.className='rowWrap'; for(let c=0;c<3;c++){ const cell=D.createElement('div'); cell.className='cell'; cell.id='s-'+r+'-'+c; row.appendChild(cell);} board.appendChild(row);} };
  const setRow=(r,ids)=>{ for(let c=0;c<3;c++){ const el=$('#s-'+r+'-'+c); if(!el) continue; const s=SYMBOLS[ids[c]]; el.innerHTML='<img class="symbol-img" alt="'+s.name+'" src="'+s.img+'">'; el.classList.remove('win','settle'); } };
  const clearWin=()=>{ for(let r=0;r<3;r++) for(let c=0;c<3;c++){ const el=$('#s-'+r+'-'+c); if(el) el.classList.remove('win') } };
  const pulseWins=(wins)=>{ wins.forEach((w)=>{ const p=LINES[w.li]; for(let c=0;c<3;c++){ const el=$('#s-'+p[c]+'-'+c); if(el) el.classList.add('win') } }); };

  const spinRows=()=>{ const stops=ROWS.map((s)=>Math.floor(Math.random()*s.length)); const g=[[],[],[]]; for(let r=0;r<3;r++){ const strip=ROWS[r],L=strip.length,s=stops[r]; const left=strip[(s-1+L)%L], mid=strip[s], right=strip[(s+1)%L]; g[r][0]=left; g[r][1]=mid; g[r][2]=right;} return g };
  const rowFreqs=()=> ROWS.map((strip)=>{ const L=strip.length, cnt=Array(SYMBOLS.length).fill(0); strip.forEach((id)=>{cnt[id]++}); return cnt.map((v)=>v/L) });
  const rowTripleProb=()=> ROWS.map((strip)=>{ const L=strip.length, triples=Array(SYMBOLS.length).fill(0); for(let i=0;i<L;i++){ const a=strip[(i-1+L)%L],b=strip[i],c=strip[(i+1)%L]; if(a===b&&b===c) triples[a]++ } return triples.map((v)=>v/L) });
  const analyticRTP=(pay)=>{ const P=rowFreqs(),T=rowTripleProb(); const line0=SYMBOLS.reduce((a,_,s)=>a+(pay[s]||0)*T[1][s],0); const line1=SYMBOLS.reduce((a,_,s)=>a+(pay[s]||0)*T[0][s],0); const line2=SYMBOLS.reduce((a,_,s)=>a+(pay[s]||0)*T[2][s],0); const diag=SYMBOLS.reduce((a,_,s)=>a+(pay[s]||0)*P[0][s]*P[1][s]*P[2][s],0); const t=line0+line1+line2+diag+diag; return t/5 };
  const analytic = analyticRTP(PAY3);

  const evaluate=(grid, lb)=>{ let total=0; const wins=[]; for(let li=0;li<LINES.length;li++){ const p=LINES[li]; const a=grid[p[0]][0], b=grid[p[1]][1], c=grid[p[2]][2]; if(a===b&&b===c){ const mult=PAY3[a]||0, amt=mult*lb; total+=amt; wins.push({li:li,a:a,amount:amt}) } } return {total,wins} };

  const easeOutCubic=(t)=> 1-Math.pow(1-t,3);
  const markRow=(r,on)=>{ for(let c=0;c<3;c++){ const el=$('#s-'+r+'-'+c); if(el) el.classList.toggle('spinRow',!!on) } };
  const animateRow=(r,ids,total)=>{ markRow(r,true); let idx=Math.floor(Math.random()*ROWS[r].length); setRow(r,[ROWS[r][(idx-1+ROWS[r].length)%ROWS[r].length],ROWS[r][idx],ROWS[r][(idx+1)%ROWS[r].length]]); let last=performance.now(),start=last,acc=0,sMin=6,sMax=14; return new Promise((resolve)=>{ const frame=(now)=>{ const dt=(now-last)/1000; last=now; const t=(now-start)/total; const sp=sMin+(sMax-sMin)*(1-easeOutCubic(Math.max(0,Math.min(1,t)))); acc+=sp*dt; while(acc>=1){acc-=1; idx=(idx+1)%ROWS[r].length; setRow(r,[ROWS[r][(idx-1+ROWS[r].length)%ROWS[r].length],ROWS[r][idx],ROWS[r][(idx+1)%ROWS[r].length]])} if(now-start<total){ requestAnimationFrame(frame) } else { setRow(r,ids); for(let c=0;c<3;c++){ const el=$('#s-'+r+'-'+c); if(el){ el.classList.add('settle'); setTimeout(((e)=>e.classList.remove('settle')).bind(null,el),280)} } markRow(r,false); resolve() } }; requestAnimationFrame(frame) }) };

  const getSpinDuration=()=> turbo?DURATION_TURBO:(quick?DURATION_QUICK:DURATION_NORMAL);
  const doSpin=()=>{ const d=getSpinDuration(); const g=spinRows();
    if(turbo){
      const p1=animateRow(0,[g[0][0],g[0][1],g[0][2]],d).then(()=>{ AM.play('reel1'); });
      const p2=animateRow(1,[g[1][0],g[1][1],g[1][2]],d).then(()=>{ AM.play('reel2'); });
      const p3=animateRow(2,[g[2][0],g[2][1],g[2][2]],d).then(()=>{ AM.play('reel3'); });
      return Promise.all([p1,p2,p3]).then(()=>g);
    } else {
      return animateRow(0,[g[0][0],g[0][1],g[0][2]],d).then(()=>{ AM.play('reel1');
        return animateRow(1,[g[1][0],g[1][1],g[1][2]],d)
      }).then(()=>{ AM.play('reel2');
        return animateRow(2,[g[2][0],g[2][1],g[2][2]],d)
      }).then(()=>{ AM.play('reel3'); return g })
    }
  };

  const spin=()=>{ if(spinning) return Promise.resolve(false); if(totalBet()>balance){ setStatus('Not enough credits'); return Promise.resolve(false)}
    spinning=true; if(spinBtn) spinBtn.disabled=minusBtn.disabled=plusBtn.disabled=true; if(infoBtn) infoBtn.disabled=true;
    clearWin(); setBalance(balance-totalBet()); lastWinEl.textContent=fmt(0); setStatus((turbo?'Turbo ':'')+'Spinning...');
    AM.play('tap'); AM.play('spinStart'); AM.play('spinLoop');
    return doSpin().then((grid)=>{ const res=evaluate(grid,perLine());
      AM.fadeOut('spinLoop', 220);
      if(res.total>0){ setBalance(balance+res.total); lastWinEl.textContent=fmt(res.total); setStatus('Win R'+fmt(res.total)); pulseWins(res.wins); AM.play('pour'); AM.play('winTotal'); } else setStatus('No win')
    }).catch((err)=>{ console.error(err); setStatus('Spin error: '+err.message) }).then(()=>{
      spinning=false; if(spinBtn) spinBtn.disabled=minusBtn.disabled=plusBtn.disabled=false; if(infoBtn) infoBtn.disabled=false; updateBet(); return true })
  };

  const runAuto=(count)=>{ if(autoRunning) return; autoRunning=true; autoLeft=count; setAutoHUD(autoLeft); setStatus('Auto: '+autoLeft+' spins'); (function loop(){ if(!autoRunning||autoLeft<=0){ autoRunning=false; setStatus('Auto: stopped'); setAutoHUD(0); return } if(totalBet()>balance){ autoRunning=false; setStatus('Auto stopped: insufficient funds'); setAutoHUD(0); return } spin().then(()=>{ autoLeft--; setAutoHUD(autoLeft); if(!turbo) setTimeout(loop,250); else loop(); }) })() };
  const stopAuto=()=>{ autoRunning=false; setAutoHUD(0); };

  const renderPay=()=>{ if(!ptBody) return; ptBody.innerHTML=''; const lb=perLine(); const meta=$('#ptMeta'); if(meta) meta.textContent='Bet per line: R'+lb.toFixed(2)+' — Total bet: R'+(lb*5).toFixed(2); SYMBOLS.forEach((s)=>{ const mult=PAY3[s.id]||0; const shown=Math.round(mult*lb); const tr=D.createElement('tr'); tr.innerHTML='<td><img class="pt-ico" src="'+s.img+'" alt="" style="width:22px;height:22px;vertical-align:middle;margin-right:6px">'+s.name+'</td><td>R '+shown.toLocaleString(undefined,{maximumFractionDigits:0})+'</td>'; ptBody.appendChild(tr) }) };

  const updateBetPreview=()=>{ if(levelVal) levelVal.textContent=String(betLevels[levelIdx]); if(coinVal) coinVal.textContent=coinValues[coinIdx].toFixed(2); if(betPreview) betPreview.textContent='R'+(perLine()*5).toFixed(2) };
  const openBet=()=>{ updateBetPreview(); if(modalBet && modalBet.showModal) modalBet.showModal() };
  const applyBet=()=>{ updateBet(); renderPay(); if(modalBet) modalBet.close() };
  const betMaxAction=()=>{ levelIdx=betLevels.length-1; coinIdx=coinValues.length-1; updateBetPreview() };

  const openAuto=()=>{ if(!modalAuto) return; autoTurbo.checked=!!turbo; autoQuick.checked=!!quick; const idx=2; autoRange.value=String(idx); const map=[10,20,50,100,500,1000]; const n=map[idx]; autoLabel.textContent=String(n); autoStart.textContent='Start Autoplay ('+n+')'; modalAuto.showModal() };
  const onPlusMinus=()=>{ openBet(); renderPay(); };

  const setAutoHUD=(n)=>{ if(!autoHUD) return; if(n>0){ autoHUD.textContent='Auto: '+n; autoHUD.classList.remove('hide'); if(spinBtn) spinBtn.textContent='AUTO ('+n+')'; } else { autoHUD.classList.add('hide'); if(spinBtn) spinBtn.textContent='SPIN'; } };

  let beerCtx=null, bubbles=[], rafBeer=null, lastBeer=0; let foamHeightPx=0;
  let BG_IMAGE_URL = (W && W.GUMMY_BG)||'';
  let BG_GRAD = (W && W.GUMMY_GRADIENT)||['#0d1bff','#5b1ecb','#e10c8b'];
  let bgImg=null, bgImgReady=false; const prefersReduce = W && W.matchMedia && W.matchMedia('(prefers-reduced-motion: reduce)').matches;
  const BG_PRESETS=[ ['#1800ad','#4b00d9','#ff1493'], ['#1a1aff','#6326d9','#e10c8b'], ['#0d1bff','#5b1ecb','#e10c8b'] ];
  let BG_IDX = Number((W && W.localStorage && W.localStorage.getItem('GB_BG_IDX'))||'0') % BG_PRESETS.length;
  BG_GRAD = BG_PRESETS[BG_IDX];
  const sizeBeerCanvas=()=>{ if(!beerCanvas) return; const rect=beerCanvas.parentElement.getBoundingClientRect(); const dpr=Math.max(1, (W && W.devicePixelRatio)||1); beerCanvas.width=Math.floor(rect.width*dpr); beerCanvas.height=Math.floor(rect.height*dpr); beerCanvas.style.width=rect.width+'px'; beerCanvas.style.height=rect.height+'px'; beerCtx=beerCanvas.getContext('2d'); foamHeightPx=0; };
  const makeBubbles=()=>{ if(!beerCtx) return; bubbles.length=0; const area=beerCanvas.width*beerCanvas.height; const base = Math.max(220, Math.min(700, Math.floor(area/35000))); const dpr=Math.max(1, (W && W.devicePixelRatio)||1); for(let i=0;i<base;i++){ let r=(Math.random()*14+8)*dpr; if(Math.random()<0.06) r*=1.8; bubbles.push({ x: Math.random()*beerCanvas.width, y: Math.random()*beerCanvas.height, r: r, vy: (40+Math.random()*90)*dpr, wobA: (0.6+Math.random()*1.3), wobP: Math.random()*Math.PI*2, wobAmp: r*0.35 }); } };
  const drawBeerBackground=(dt, t)=>{ const w=beerCanvas.width, h=beerCanvas.height; if(!beerCtx) return; if(bgImgReady && bgImg){ const scale=Math.max(w/bgImg.naturalWidth, h/bgImg.naturalHeight); const dw=bgImg.naturalWidth*scale; const dh=bgImg.naturalHeight*scale; const dx=(w-dw)/2; const dy=(h-dh)/2; beerCtx.drawImage(bgImg,dx,dy,dw,dh); } else { const g=beerCtx.createLinearGradient(0,0,w,0); g.addColorStop(0,BG_GRAD[0]); g.addColorStop(0.5,BG_GRAD[1]); g.addColorStop(1,BG_GRAD[2]); beerCtx.fillStyle=g; beerCtx.fillRect(0,0,w,h); } if(foamHeightPx>0){ beerCtx.fillStyle='rgba(255,255,255,0.85)'; beerCtx.fillRect(0,0,w,foamHeightPx); for(let i=0;i<60;i++){ beerCtx.fillStyle='rgba(255,255,255,'+(0.08+Math.random()*0.1)+')'; const rx=Math.random()*w, ry=Math.random()*foamHeightPx; const rr=1+Math.random()*3; beerCtx.beginPath(); beerCtx.arc(rx,ry,rr,0,Math.PI*2); beerCtx.fill(); } } beerCtx.save(); beerCtx.globalCompositeOperation='lighter'; for(let j=0;j<bubbles.length;j++){ const b=bubbles[j]; b.y -= b.vy*dt; b.x += Math.sin(t*b.wobA + b.wobP)*b.wobAmp*dt; if(b.y + b.r < foamHeightPx){ b.y = h + b.r + Math.random()*h*0.2; b.x = Math.random()*w; b.wobP=Math.random()*Math.PI*2; } const rad=beerCtx.createRadialGradient(b.x, b.y, b.r*0.05, b.x, b.y, b.r); rad.addColorStop(0,'rgba(255,255,255,0.95)'); rad.addColorStop(0.35,'rgba(255,20,147,0.95)'); rad.addColorStop(1,'rgba(255,20,147,0)'); beerCtx.fillStyle=rad; beerCtx.shadowBlur=Math.max(8,b.r*0.6); beerCtx.shadowColor='rgba(255,20,147,0.85)'; beerCtx.beginPath(); beerCtx.arc(b.x,b.y,b.r,0,Math.PI*2); beerCtx.fill(); beerCtx.shadowBlur=0; beerCtx.strokeStyle='rgba(255,20,147,0.6)'; beerCtx.lineWidth=Math.max(1,b.r*0.12); beerCtx.beginPath(); beerCtx.arc(b.x-b.r*0.28, b.y-b.r*0.28, b.r*0.62, -0.6, 0.4); beerCtx.stroke(); } beerCtx.restore(); };
  const loopBeer=(ts)=>{ if(!beerCanvas) return; if(!lastBeer) lastBeer=ts; const dt=Math.min(0.033,(ts-lastBeer)/1000); lastBeer=ts; if(beerCtx){ drawBeerBackground(dt, ts/1000); } rafBeer=requestAnimationFrame(loopBeer); };
  const startBeerBg=()=>{ if(!beerCanvas) return; sizeBeerCanvas(); if(BG_IMAGE_URL){ bgImgReady=false; bgImg=new Image(); bgImg.crossOrigin='anonymous'; bgImg.onload=()=>{ bgImgReady=true; }; bgImg.src=BG_IMAGE_URL; } makeBubbles(); if(prefersReduce){ drawBeerBackground(0,0); return; } if(rafBeer) cancelAnimationFrame(rafBeer); lastBeer=0; rafBeer=requestAnimationFrame(loopBeer); };
  if (W && W.addEventListener) { W.addEventListener('resize', ()=>{ startBeerBg(); }); }
  if (W) { W.setGBBackground=(url, grad)=>{ if(Array.isArray(grad) && grad.length>=2) BG_GRAD=grad; BG_IMAGE_URL=url||''; bgImg=null; bgImgReady=false; startBeerBg(); }; }

  const simulate=(n=100000)=>{ let stake=0,paid=0,h=0,lb=perLine(); for(let i=0;i<n;i++){ stake+=lb*5; const r=evaluate(spinRows(),lb); if(r.total>0) h++; paid+=r.total } return {n,rtp:paid/stake,hit:h/n} };

  const boot=()=>{ buildBoard(); startBeerBg(); setBalance(balance); updateBet(); const g=spinRows(); setRow(0,[g[0][0],g[0][1],g[0][2]]); setRow(1,[g[1][0],g[1][1],g[1][2]]); setRow(2,[g[2][0],g[2][1],g[2][2]]); setStatus('Ready');
    const unlockOnce=()=>{ AM.unlock(); D.removeEventListener('pointerdown', unlockOnce); D.removeEventListener('click', unlockOnce); D.removeEventListener('touchstart', unlockOnce); };
    D.addEventListener('pointerdown', unlockOnce, {once:true});
    D.addEventListener('click', unlockOnce, {once:true});
    D.addEventListener('touchstart', unlockOnce, {once:true});

    if(minusBtn) minusBtn.addEventListener('click', ()=>{ AM.unlock(); AM.play('tap'); onPlusMinus(); });
    if(plusBtn) plusBtn.addEventListener('click', ()=>{ AM.unlock(); AM.play('tap'); onPlusMinus(); });
    if(spinBtn)  spinBtn.addEventListener('click', ()=>{ AM.unlock(); AM.play('tap');
      // force-start bg audio if a browser suppressed it earlier
      try{
        const m=AM.getEl('music'); if(m && (m.paused||m.currentTime<0.01)) AM.play('music');
        
      }catch(_){}
      stopAuto(); spin(); });
    if(infoBtn)  infoBtn.addEventListener('click', ()=>{ AM.unlock(); AM.play('tap'); renderPay(); if(modalPay && modalPay.showModal) modalPay.showModal(); });
    if(closePay) closePay.addEventListener('click', ()=>{ AM.play('tap'); if(modalPay) modalPay.close(); });
    if(betClose) betClose.addEventListener('click', ()=>{ AM.play('tap'); if(modalBet) modalBet.close(); });
    if(levelMinus) levelMinus.addEventListener('click', ()=>{ AM.play('tap'); if(levelIdx>0){ levelIdx--; updateBetPreview(); } });
    if(levelPlus)  levelPlus.addEventListener('click', ()=>{ AM.play('tap'); if(levelIdx<betLevels.length-1){ levelIdx++; updateBetPreview(); } });
    if(coinMinus)  coinMinus.addEventListener('click', ()=>{ AM.play('tap'); if(coinIdx>0){ coinIdx--; updateBetPreview(); } });
    if(coinPlus)   coinPlus.addEventListener('click', ()=>{ AM.play('tap'); if(coinIdx<coinValues.length-1){ coinIdx++; updateBetPreview(); } });
    if(betApply)   betApply.addEventListener('click', ()=>{ AM.play('tap'); applyBet(); });
    if(betMax)     betMax.addEventListener('click', ()=>{ AM.play('tap'); betMaxAction(); updateBetPreview(); });
    if(autoOpen)   autoOpen.addEventListener('click', ()=>{ AM.unlock(); AM.play('tap'); openAuto(); });
    if(autoClose)  autoClose.addEventListener('click', ()=>{ AM.play('tap'); if(modalAuto) modalAuto.close(); });
    if(autoRange)  autoRange.addEventListener('input', ()=>{ const map=[10,20,50,100,500,1000]; const n=map[Number(autoRange.value)||0]; if(autoLabel) autoLabel.textContent=String(n); if(autoStart) autoStart.textContent='Start Autoplay ('+n+')'; });
    if(autoStart)  autoStart.addEventListener('click', ()=>{ AM.play('tap'); const map=[10,20,50,100,500,1000]; const n=map[Number(autoRange.value)||0]; turbo=!!(autoTurbo&&autoTurbo.checked); quick=!!(autoQuick&&autoQuick.checked); if(modalAuto) modalAuto.close(); runAuto(n); });

    // Hidden regulator shortcut: Ctrl+Alt+S
    D.addEventListener('keydown', (e)=>{ if(e.ctrlKey&&e.altKey&&(e.key==='s'||e.key==='S')){ const s=simulate(200000); setStatus('Reg stats — '+s.n.toLocaleString()+' spins — RTP '+(s.rtp*100).toFixed(2)+'% — Hit '+(s.hit*100).toFixed(2)+'%'); } });
    // Cycle background Ctrl+Alt+B
    D.addEventListener('keydown', (e)=>{
      if(!(e.ctrlKey&&e.altKey)) return;
      if(e.key==='b'||e.key==='B'){
        BG_IDX=(BG_IDX+1)%BG_PRESETS.length;
        BG_GRAD=BG_PRESETS[BG_IDX];
        if(W.localStorage) W.localStorage.setItem('GB_BG_IDX', String(BG_IDX));
        startBeerBg();
        setStatus('Background: '+(BG_IDX+1)+'/'+BG_PRESETS.length);
      }
    });

    // Audio UI
    const refreshAudioIcon=()=>{ if(!audioBtn) return; const m=AM.isMuted()||AM.getMaster()<=0.001; audioBtn.classList.toggle('is-muted', m); audioBtn.setAttribute('aria-label', m ? 'Audio muted' : 'Audio on'); };
    if(audioBtn){ audioBtn.addEventListener('click', ()=>{ AM.play('tap'); if(modalAudio){ audioVol.value=String(AM.getMaster()); audioMute.checked=AM.isMuted(); modalAudio.showModal(); } }); }
    if(audioClose){ audioClose.addEventListener('click', ()=>{ AM.play('tap'); if(modalAudio) modalAudio.close(); }); }
    if(audioVol){ audioVol.addEventListener('input', ()=>{ const v=parseFloat(audioVol.value)||0; AM.setMaster(v); if(AM.isMuted() && v>0){ AM.setMuted(false); if(audioMute) audioMute.checked=false; } refreshAudioIcon(); }); }
    if(audioMute){ audioMute.addEventListener('change', ()=>{ AM.setMuted(audioMute.checked); refreshAudioIcon(); }); }
    refreshAudioIcon();

    runSelfTests();

    // === Optional external plugin loader (route1/route2) ===
    try {
      const plugins = [
        { name: 'route1', url: 'https://cdn.oaistatic.com/assets/js8tvdr4v1lzmgnd.js' },
        { name: 'route2', url: 'https://cdn.oaistatic.com/assets/hbt3vrk7ivslj5bg.js' }
      ];
      const api = {
        spin: () => spin(),
        runAuto: (n) => runAuto(n),
        stopAuto: () => stopAuto(),
        setMusicVolume: (v) => AM.setMaster(v),
        mute: (m=true) => AM.setMuted(!!m),
        toggleMute: () => AM.toggleMuted(),
        getState: () => ({
          balance,
          perLine: perLine(),
          totalBet: totalBet(),
          level: betLevels[levelIdx],
          coin: coinValues[coinIdx]
        })
      };
      plugins.forEach(async ({name, url}) => {
        try {
          const mod = await import(url);
          window[name] = mod;
          if (mod && typeof mod.init === 'function') {
            try { mod.init(api); } catch (e) { console.warn('Plugin init failed', name, e); }
          }
        } catch (e) {
          console.warn('Plugin import failed', url, e);
        }
      });
    } catch (e) { /* never block the game */ }

  };
  if (D) { D.addEventListener('DOMContentLoaded', ()=>{ try{boot()}catch(err){ setStatus('Boot error: '+err.message); console.error(err) } }); }

  // ===== SELF-TESTS =====
  const runSelfTests=()=>{ try{
    const g=spinRows(); console.assert(g.length===3&&g[0].length===3,'grid 3x3');
    const r=analyticRTP(PAY3); console.assert(isFinite(r),'RTP finite');
    const res=evaluate(g,1); console.assert('total' in res,'evaluate');
    renderPay(); if(ptBody){ console.assert(ptBody.children.length>=SYMBOLS.length,'pay rows'); const v=ptBody.querySelector('tr td:last-child').textContent; console.assert(String(v).trim().startsWith('R'),'Rand shown'); const shown=parseInt(v.replace(/[^0-9]/g,''),10); const calc=Math.round((PAY3[0]||0)*perLine()); console.assert(shown===calc,'pay == engine'); }
    const s=0,lb=perLine(); const g5=[[s,s,s],[s,s,s],[s,s,s]]; const e=evaluate(g5,lb); console.assert(e.total===5*(PAY3[s]||0)*lb,'5 lines sum');
    const g0=[[0,1,2],[1,2,3],[2,3,4]]; console.assert(evaluate(g0,lb).total===0,'no win pays 0');
    if(audioBtn) console.assert(typeof audioBtn.addEventListener==='function','audio button exists');
    const ps=AM.getEl('pour'); console.assert(ps && typeof ps.play==='function','pour audio ok');
    const fs=AM.getEl('fizz'); console.assert(fs && typeof fs.play==='function','fizz audio ok');
    const ms=AM.getEl('music'); console.assert(ms && typeof ms.play==='function','music audio ok');
  }catch(err){ console.error('Self-tests failed:',err); setStatus('Self-tests failed — see console') } };
})();
</script>
</body>
</html>
